<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeSquare | The Eternal Vault</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #38bdf8; --text: #f8fafc; --gold: #facc15; --success: #22c55e; --error: #ef4444; --glass: rgba(255, 255, 255, 0.05); }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; overflow-x: hidden; scroll-behavior: smooth; }
        
        /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        header { padding: 60px 20px; text-align: center; position: relative; }
        h1 { font-family: 'Orbitron', sans-serif; font-size: clamp(3rem, 10vw, 5rem); font-weight: 900; margin: 0; cursor: pointer; background: linear-gradient(to bottom, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(56, 189, 248, 0.5)); }
        
        .stats-bar { background: var(--glass); backdrop-filter: blur(10px); padding: 10px 30px; border-radius: 50px; border: 1px solid rgba(56, 189, 248, 0.3); display: inline-block; margin-top: 20px; font-weight: bold; letter-spacing: 1px; }

        /* Ø§Ù„Ø¬Ø±ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 30px; max-width: 1400px; margin: auto; }
        
        .square { aspect-ratio: 1; background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; cursor: pointer; transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1); display: flex; align-items: center; justify-content: center; }
        
        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‚ÙÙ„ Ù„Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© */
        .square.empty::before { content: '\f023'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 1.5rem; color: rgba(255,255,255,0.1); transition: 0.3s; }
        .square.empty:hover::before { color: var(--accent); transform: scale(1.2) rotate(-10deg); }
        .square.empty:hover { background: rgba(56, 189, 248, 0.05); border-color: var(--accent); box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }

        .square img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .square:hover img { transform: scale(1.1); filter: brightness(1.1); }
        
        /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© */
        .name-tag { position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.8)); font-size: 0.75rem; padding: 10px 0; text-align: center; font-weight: bold; }
        
        /* Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ø±Ø³ */
        .guardian-icon { position: absolute; top: 8px; right: 8px; font-size: 0.9rem; z-index: 2; background: rgba(0,0,0,0.5); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid var(--gold); }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); z-index: 9999; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #0f172a; padding: 40px; border-radius: 30px; width: 100%; max-width: 500px; border: 1px solid rgba(56, 189, 248, 0.5); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        #adminPanel { position: fixed; bottom: 30px; left: 30px; z-index: 10000; display: none; }
        .admin-btn { background: var(--gold); color: #000; padding: 15px 25px; border-radius: 50px; font-weight: 900; cursor: pointer; box-shadow: 0 10px 20px rgba(250, 204, 21, 0.3); border: none; display: flex; align-items: center; gap: 10px; }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø±Ø³ */
        .guardian-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .g-opt { padding: 10px; border: 1px solid #334155; border-radius: 12px; cursor: pointer; text-align: center; transition: 0.3s; font-size: 1.2rem; }
        .g-opt.active { background: var(--accent); border-color: var(--accent); transform: scale(1.1); }

        .ad-spot { width: 100%; height: 90px; background: var(--glass); border: 1px dashed #334155; margin: 20px 0; display: flex; align-items: center; justify-content: center; border-radius: 15px; color: #475569; font-weight: bold; }
    </style>
</head>
<body>

    <canvas id="starfield"></canvas>

    <header>
        <h1 onclick="adminLogin()">LifeSquare</h1>
        <div class="stats-bar">
            <i class="fas fa-globe-americas"></i> <span id="memCount">0</span> LEGACIES SECURED
        </div>
    </header>

    <div class="grid" id="mainGrid"></div>

    <div id="adminPanel">
        <button class="admin-btn" onclick="openAdminDashboard()">
            <i class="fas fa-user-shield"></i> COMMAND CENTER
        </button>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-box">
            <h2 style="margin-top:0; color:var(--accent)">Secure Your Legacy</h2>
            <div id="formSection">
                <input id="name" placeholder="Full Name">
                <input id="country" placeholder="Country (e.g. USA, UK, Egypt)">
                <textarea id="story" placeholder="Your story for eternity..." rows="3"></textarea>
                
                <p style="font-size: 0.8rem; color: #94a3b8; margin: 10px 0 5px;">Choose Your Guardian Agent:</p>
                <div class="guardian-selector" id="gSelector">
                    <div class="g-opt active" data-icon="ğŸ›¡ï¸">ğŸ›¡ï¸</div>
                    <div class="g-opt" data-icon="ğŸ¦">ğŸ¦</div>
                    <div class="g-opt" data-icon="ğŸ¤–">ğŸ¤–</div>
                    <div class="g-opt" data-icon="ğŸ‰">ğŸ‰</div>
                </div>

                <input type="file" id="imgFile" accept="image/*" style="font-size: 0.8rem;">
                <button class="btn-main" id="saveBtn"><i class="fas fa-bolt"></i> BLAST TO ETERNITY</button>
            </div>

            <div id="successSection" style="display:none; text-align: center;">
                <div id="certificateCard">
                    <h3 style="color:var(--gold)">VERIFIED LEGACY</h3>
                    <p>This is to certify that</p>
                    <h2 id="certName" style="color:#fff"></h2>
                    <p>Has been immortalized in Square #<span id="certId"></span></p>
                    <div style="font-size: 0.7rem; color: #475569; margin-top: 10px;">SECURED VIA LIFESQUARE PROTOCOL</div>
                </div>
                <button class="btn-main" onclick="location.reload()">BACK TO GRID</button>
            </div>
            <button onclick="closeModal('addModal')" id="cancelBtn" style="background:none; color:#666; border:none; width:100%; margin-top:10px; cursor:pointer;">CANCEL</button>
        </div>
    </div>

    <div class="modal" id="adminDashboard">
        <div class="modal-box" style="max-width: 600px;">
            <h2 style="color:var(--gold)">Admin Intelligence</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-main" onclick="changeGridSize()">Resize Grid</button>
                <button class="btn-main" onclick="toggleAds()">Toggle Ads</button>
                <button class="btn-main" onclick="exportData()">Export Analytics</button>
                <button class="btn-main" onclick="logoutAdmin()" style="background:var(--error); color:#fff">System Logout</button>
            </div>
            <div class="ad-spot">Revenue Stats: 0.00$</div>
            <button onclick="closeModal('adminDashboard')" style="width:100%; margin-top:20px; background:none; border:none; color:#666; cursor:pointer;">CLOSE</button>
        </div>
    </div>

    <div class="modal" id="viewModal">
        <div class="modal-box" id="viewBox" style="text-align: center;"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
        
        const SB_URL = "https://fnbdhcncujueyznrlmpi.supabase.co";
        const SB_KEY = "sb_publishable_wzpxcVJxxAIElNknL8hUHA_GCDzvcVR";
        const supabase = createClient(SB_URL, SB_KEY);

        let gridSize = 200;
        let selectedGuardian = "ğŸ›¡ï¸";
        let isAdmin = localStorage.getItem('isSiteAdmin') === 'true';

        // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¬ÙˆÙ…
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            stars = [];
            for(let i=0; i<200; i++) stars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, size: Math.random()*2, speed: Math.random()*0.5});
        }
        function drawStars() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "#fff";
            stars.forEach(s => {
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
                s.y += s.speed; if(s.y > canvas.height) s.y = 0;
            });
            requestAnimationFrame(drawStars);
        }
        window.addEventListener('resize', initStars); initStars(); drawStars();

        // Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        window.adminLogin = () => {
            if(prompt("ACCESS CODE:") === "123") {
                isAdmin = true; localStorage.setItem('isSiteAdmin', 'true');
                document.getElementById('adminPanel').style.display = 'block';
            }
        };
        window.openAdminDashboard = () => document.getElementById('adminDashboard').style.display = 'flex';
        window.logoutAdmin = () => { localStorage.removeItem('isSiteAdmin'); location.reload(); };
        window.changeGridSize = () => { gridSize = prompt("New Grid Size:", gridSize); loadWall(); };

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø±Ø³
        document.querySelectorAll('.g-opt').forEach(opt => {
            opt.onclick = () => {
                document.querySelectorAll('.g-opt').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                selectedGuardian = opt.dataset.icon;
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ø¦Ø· Ø¨ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø³
        async function loadWall() {
            const grid = document.getElementById("mainGrid");
            const { data } = await supabase.from("memories").select("*");
            const map = {};
            data?.forEach(m => map[m.square_id] = m);
            document.getElementById('memCount').innerText = data?.length || 0;
            if(isAdmin) document.getElementById('adminPanel').style.display = 'block';

            grid.innerHTML = "";
            for (let i = 1; i <= gridSize; i++) {
                let sq = document.createElement("div");
                sq.className = "square " + (map[i] ? "occupied" : "empty");
                let m = map[i];

                if(m) {
                    sq.innerHTML = `
                        <img src="${m.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=Protected'">
                        <div class="guardian-icon">${m.guardian || 'ğŸ›¡ï¸'}</div>
                        <div class="name-tag">${m.name}</div>
                    `;
                    sq.onclick = () => showMemory(m);
                } else {
                    sq.onclick = () => { window.selectedId = i; document.getElementById('addModal').style.display='flex'; };
                }
                grid.appendChild(sq);
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø®ØªØ§Ø±
        document.getElementById("saveBtn").onclick = async () => {
            const btn = document.getElementById("saveBtn");
            const file = document.getElementById("imgFile").files[0];
            const name = document.getElementById("name").value;
            if(!name || !file) return alert("Full Name and Image are required!");

            btn.disabled = true; btn.innerText = "UPLOADING TO VAULT...";

            const fileName = `sq_${Date.now()}.jpg`;
            const { data: upData } = await supabase.storage.from("memories").upload(fileName, file);
            const publicUrl = `${SB_URL}/storage/v1/object/public/memories/${fileName}`;

            const { error } = await supabase.from("memories").insert([{
                square_id: window.selectedId,
                name: name,
                story: document.getElementById("story").value,
                country: document.getElementById("country").value,
                image_url: publicUrl,
                guardian: selectedGuardian // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø®ØªØ§Ø±
            }]);

            if(!error) {
                document.getElementById('formSection').style.display = 'none';
                document.getElementById('successSection').style.display = 'block';
                document.getElementById('certName').innerText = name;
                document.getElementById('certId').innerText = window.selectedId;
            } else {
                alert("Error: " + error.message); btn.disabled = false;
            }
        };

        window.closeModal = id => document.getElementById(id).style.display = "none";
        window.onload = loadWall;
    </script>
</body>
</html>
