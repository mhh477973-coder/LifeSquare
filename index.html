<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeSquare | Ø§Ù„Ø°ÙƒØ±Ù‰ Ø§Ù„Ø®Ø§Ù„Ø¯Ø©</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #38bdf8; --text: #f8fafc; --gold: #facc15; --success: #22c55e; --error: #ef4444; --glass: rgba(255, 255, 255, 0.05); }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; overflow-x: hidden; scroll-behavior: smooth; }
        #starfield { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        header { padding: 60px 20px; text-align: center; }
        h1 { font-family: 'Orbitron', sans-serif; font-size: clamp(2.5rem, 8vw, 4rem); font-weight: 900; margin: 0; cursor: pointer; background: linear-gradient(45deg, #fff, var(--accent), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px rgba(56, 189, 248, 0.3)); }
        
        .stats-bar { background: var(--glass); backdrop-filter: blur(10px); padding: 10px 30px; border-radius: 50px; border: 1px solid rgba(56, 189, 248, 0.3); display: inline-block; margin-top: 20px; font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(115px, 1fr)); gap: 15px; padding: 30px; max-width: 1400px; margin: auto; }
        
        .square { aspect-ratio: 1; background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; justify-content: center; }
        .square:hover { transform: translateY(-5px) scale(1.05); border-color: var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 5; }
        
        .square.empty::before { content: '\f023'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 1.5rem; color: rgba(255,255,255,0.05); }
        .square img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        
        .name-tag { position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.9)); font-size: 0.7rem; padding: 8px 0; text-align: center; font-weight: bold; }
        .guardian-icon { position: absolute; top: 8px; right: 8px; font-size: 0.8rem; background: rgba(0,0,0,0.6); width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid var(--gold); z-index: 2; }
        .crown { position: absolute; top: 8px; left: 8px; color: var(--gold); font-size: 0.8rem; z-index: 2; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index: 9999; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: var(--card); padding: 30px; border-radius: 25px; width: 100%; max-width: 450px; border: 1px solid var(--accent); position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }

        input, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #020617; border: 1px solid #334155; color: #fff; border-radius: 12px; box-sizing: border-box; }
        .btn-main { background: var(--accent); color: #020617; padding: 15px; border: none; border-radius: 12px; width: 100%; font-weight: 900; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        
        .guardian-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .g-opt { padding: 10px; border: 1px solid #334155; border-radius: 12px; cursor: pointer; text-align: center; transition: 0.3s; font-size: 1.2rem; }
        .g-opt.active { background: var(--accent); transform: scale(1.1); }

        #adminTools { display: none; position: fixed; bottom: 25px; left: 25px; background: var(--gold); color: #000; padding: 15px 25px; border-radius: 50px; font-weight: 900; cursor: pointer; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        
        #certificateCard { background: linear-gradient(135deg, #1e293b 0%, #020617 100%); border: 3px solid var(--gold); padding: 20px; border-radius: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <canvas id="starfield"></canvas>

    <header>
        <h1 onclick="adminLogin()">LifeSquare</h1>
        <div class="stats-bar">âœ¨ <span id="memCount">0</span> LEGACIES SECURED</div>
    </header>

    <div class="grid" id="mainGrid"></div>

    <button id="adminTools" onclick="openAdminPanel()">âš™ï¸ CONTROL CENTER</button>

    <div class="modal" id="addModal">
        <div class="modal-box">
            <h2 style="color:var(--accent); margin-top:0">ØªØ®Ù„ÙŠØ¯ Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <div id="formSection">
                <input id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input id="country" placeholder="Ø§Ù„Ø¯ÙˆÙ„Ø©">
                <textarea id="story" placeholder="Ù‚ØµØªÙƒ Ù„Ù„Ø£Ø¨Ø¯..." rows="3"></textarea>
                
                <p style="font-size: 0.8rem; color: #94a3b8; margin: 10px 0 5px;">Ø§Ø®ØªØ± Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ø¨Ø¹:</p>
                <div class="guardian-selector">
                    <div class="g-opt active" onclick="selectG(this, 'ğŸ›¡ï¸')">ğŸ›¡ï¸</div>
                    <div class="g-opt" onclick="selectG(this, 'ğŸ¦')">ğŸ¦</div>
                    <div class="g-opt" onclick="selectG(this, 'ğŸ¤–')">ğŸ¤–</div>
                    <div class="g-opt" onclick="selectG(this, 'ğŸ‰')">ğŸ‰</div>
                </div>

                <input type="file" id="imgFile" accept="image/*">
                <button class="btn-main" id="saveBtn">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ù„ÙˆØ¯</button>
            </div>

            <div id="successSection" style="display:none; text-align: center;">
                <div id="certificateCard">
                    <h3 style="color:var(--gold); margin:0">Ø´Ù‡Ø§Ø¯Ø© ØªÙˆØ«ÙŠÙ‚</h3>
                    <p style="font-size:0.9rem">ØªÙ… ØªØ®Ù„ÙŠØ¯ Ø§Ù„Ø§Ø³Ù…:</p>
                    <h2 id="certName"></h2>
                    <p>ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø±Ù‚Ù…: <span id="certId" style="color:var(--accent)"></span></p>
                </div>
                <button class="btn-main" onclick="location.reload()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø§Ø¦Ø·</button>
            </div>
            <button onclick="closeModal('addModal')" style="background:none; color:#666; border:none; width:100%; margin-top:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal" id="viewModal">
        <div class="modal-box" id="viewBox" style="text-align: center;"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¨Ø· (ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡Ø§)
        const SB_URL = "https://fnbdhcncujueyznrlmpi.supabase.co";
        const SB_KEY = "sb_publishable_wzpxcVJxxAIElNknL8hUHA_GCDzvcVR"; 
        const supabase = createClient(SB_URL, SB_KEY);

        let gridSize = 200;
        let selectedGuardian = "ğŸ›¡ï¸";
        let isAdmin = localStorage.getItem('isSiteAdmin') === 'true';

        // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¬ÙˆÙ…
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            stars = [...Array(150)].map(() => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2, sp: Math.random()*0.5}));
        }
        function drawStars() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "#fff";
            stars.forEach(s => { ctx.fillRect(s.x, s.y, s.s, s.s); s.y += s.sp; if(s.y > canvas.height) s.y = 0; });
            requestAnimationFrame(drawStars);
        }
        initStars(); drawStars(); window.onresize = initStars;

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ø±Ø³
        window.selectG = (el, icon) => {
            document.querySelectorAll('.g-opt').forEach(o => o.classList.remove('active'));
            el.classList.add('active');
            selectedGuardian = icon;
        };

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ø¦Ø·
        async function loadWall() {
            const grid = document.getElementById("mainGrid");
            const { data } = await supabase.from("memories").select("*");
            const map = {};
            data?.forEach(m => map[m.square_id] = m);
            document.getElementById('memCount').innerText = data?.length || 0;
            if(isAdmin) document.getElementById('adminTools').style.display = 'block';

            grid.innerHTML = "";
            for (let i = 1; i <= gridSize; i++) {
                let sq = document.createElement("div");
                sq.className = "square " + (map[i] ? "occupied" : "empty");
                if(map[i]) {
                    sq.innerHTML = `
                        <img src="${map[i].image_url}" loading="lazy">
                        <div class="guardian-icon">${map[i].guardian || 'ğŸ›¡ï¸'}</div>
                        <div class="name-tag">${map[i].name}</div>
                        ${i <= 10 ? '<i class="fas fa-crown crown"></i>' : ''}
                    `;
                    sq.onclick = () => showMemory(map[i]);
                } else {
                    sq.onclick = () => { window.selectedId = i; document.getElementById('addModal').style.display='flex'; };
                }
                grid.appendChild(sq);
            }
        }

        window.showMemory = (m) => {
            const v = document.getElementById("viewBox");
            v.innerHTML = `
                <img src="${m.image_url}" style="width:100%; border-radius:15px; border:2px solid var(--accent)">
                <h2 style="color:var(--gold)">${m.name}</h2>
                <p style="color:var(--accent)">ğŸ“ ${m.country || 'Ø£Ø±Ø¶ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª'}</p>
                <p style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;">"${m.story || 'Ø¨Ø¯ÙˆÙ† Ù‚ØµØ©...'}"</p>
                <button class="btn-main" onclick="shareMe('${m.name}', ${m.square_id})"><i class="fas fa-share"></i> Ù…Ø´Ø§Ø±ÙƒØ©</button>
                <button onclick="closeModal('viewModal')" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
            `;
            document.getElementById('viewModal').style.display='flex';
        };

        window.shareMe = (name, id) => {
            if(navigator.share) {
                navigator.share({ title: 'LifeSquare', text: `Ø´Ø§Ù‡Ø¯ Ø°ÙƒØ±Ù‰ ${name} Ø§Ù„Ø®Ø§Ù„Ø¯Ø©!`, url: window.location.href });
            } else {
                alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø§Ù†Ø´Ø±Ù‡ Ø§Ù„Ø¢Ù† âœ¨");
            }
        };

        document.getElementById("saveBtn").onclick = async () => {
            const btn = document.getElementById("saveBtn");
            const file = document.getElementById("imgFile").files[0];
            const name = document.getElementById("name").value;
            if(!name || !file) return alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†!");

            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

            const fileName = `sq_${Date.now()}.jpg`;
            const { data: upData } = await supabase.storage.from("memories").upload(fileName, file);
            const publicUrl = `${SB_URL}/storage/v1/object/public/memories/${fileName}`;

            const { error } = await supabase.from("memories").insert([{
                square_id: window.selectedId,
                name: name,
                story: document.getElementById("story").value,
                country: document.getElementById("country").value,
                image_url: publicUrl,
                guardian: selectedGuardian
            }]);

            if(!error) {
                document.getElementById('formSection').style.display = 'none';
                document.getElementById('successSection').style.display = 'block';
                document.getElementById('certName').innerText = name;
                document.getElementById('certId').innerText = window.selectedId;
            } else {
                alert("Ø®Ø·Ø£: " + error.message); btn.disabled = false;
            }
        };

        window.adminLogin = () => { if(prompt("Code:") === "123") { isAdmin=true; localStorage.setItem('isSiteAdmin','true'); location.reload(); } };
        window.closeModal = id => document.getElementById(id).style.display = "none";
        window.onload = loadWall;
    </script>
</body>
</html>
