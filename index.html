<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeSquare | Global Memory Wall</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #38bdf8; --text: #f8fafc; --ghost: #94a3b8; --gold: #facc15; --success: #22c55e; --ad-bg: #1e293b; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Cairo', 'Inter', sans-serif; transition: 0.3s; }
        .ad-space { background: var(--ad-bg); padding: 10px; text-align: center; color: var(--ghost); font-size: 0.8rem; border: 1px dashed #334155; margin: 10px auto; max-width: 900px; border-radius: 8px; }
        header { padding: 40px 20px; }
        h1 { font-size: 3.5rem; font-weight: 900; letter-spacing: -2px; margin: 0; background: linear-gradient(to right, #38bdf8, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .lang-switch { position: absolute; top: 20px; left: 20px; }
        .lang-btn { background: var(--card); border: 1px solid var(--accent); color: var(--text); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; padding: 20px; max-width: 1400px; margin: auto; }
        .square { aspect-ratio: 1; background: var(--card); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; border: 1px solid #1e293b; position: relative; overflow: hidden; }
        .square:hover { transform: translateY(-5px) scale(1.05); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .occupied { border-color: var(--success); background: linear-gradient(145deg, #1e293b, #0f172a); }
        .premium { border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(250, 204, 21, 0.3); }
        .square img { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0.4; }
        .square span { z-index: 2; font-weight: bold; font-size: 0.7rem; text-align: center; padding: 2px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-box { background: var(--card); padding: 30px; border-radius: 20px; width: 100%; max-width: 450px; border: 1px solid var(--accent); position: relative; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; background: #020617; border: 1px solid #334155; color: #fff; border-radius: 10px; box-sizing: border-box; }
        button { padding: 15px; border: none; border-radius: 10px; width: 100%; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 10px; }
        .btn-main { background: var(--accent); color: #020617; }
        .btn-close { background: transparent; color: var(--ghost); border: 1px solid var(--ghost); }
        .stats-bar { background: rgba(56, 189, 248, 0.1); padding: 10px; border-radius: 50px; display: inline-block; margin-bottom: 20px; font-size: 0.9rem; color: var(--accent); }
    </style>
</head>
<body>
    <div class="lang-switch"><button class="lang-btn" onclick="toggleLang()">English / Ø¹Ø±Ø¨ÙŠ</button></div>
    <div class="ad-space">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¹Ù„ÙˆÙŠØ© - Advertisement Space</div>
    <header>
        <h1 id="title">LifeSquare</h1>
        <div class="stats-bar" id="stats">...</div>
        <p id="subtitle">Ø§Ø­Ø¬Ø² Ù…ÙƒØ§Ù†Ùƒ ÙÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</p>
    </header>
    <div class="grid" id="grid"></div>
    <div class="ad-space">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø³ÙÙ„ÙŠØ© - Advertisement Space</div>
    <div class="modal" id="addModal"><div class="modal-box"><h2>Ø£Ø¶Ù Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø©</h2><input id="name" placeholder="Ø§Ù„Ø§Ø³Ù… / Name"><input id="country" placeholder="Ø§Ù„Ø¨Ù„Ø¯ / Country"><textarea id="story" maxlength="250" placeholder="Ù…Ø§ Ù‡ÙŠ Ù‚ØµØªÙƒØŸ"></textarea><input type="file" id="imageInput" accept="image/*"><label><input type="checkbox" id="ghostCheck"> ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸ‘»</label><button class="btn-main" id="saveBtn">Ø­ÙØ¸ ÙˆØªØ®Ù„ÙŠØ¯ Ø§Ù„Ø°ÙƒØ±Ù‰</button><button class="btn-close" onclick="closeModal('addModal')">Ø¥ØºÙ„Ø§Ù‚</button></div></div>
    <div class="modal" id="viewModal"><div class="modal-box" id="viewBox"></div></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
        const supabase = createClient("https://fnbdhcncujueyznrlmpi.supabase.co", "sb_publishable_wzpxcVJxxAIElNknL8hUHA_GCDzvcVR")
        let currentLang = 'ar', selectedSquare = null, totalSquares = 200;
        window.toggleLang = () => { currentLang = currentLang === 'ar' ? 'en' : 'ar'; document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr'; updateUI(); };
        function updateUI() { document.getElementById('title').innerText = "LifeSquare"; document.getElementById('subtitle').innerText = currentLang === 'ar' ? 'Ø§Ø­Ø¬Ø² Ù…ÙƒØ§Ù†Ùƒ ÙÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ' : 'Reserve your spot on the global digital wall'; loadWall(); }
        window.openModal = id => document.getElementById(id).style.display = "flex";
        window.closeModal = id => document.getElementById(id).style.display = "none";

        async function loadWall() {
            const grid = document.getElementById("grid"); grid.innerHTML = "";
            const { data } = await supabase.from("memories").select("*");
            const map = {}; data?.forEach(m => map[m.square_id] = m);
            document.getElementById("stats").innerText = currentLang === 'ar' ? `Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©: ${data ? data.length : 0}` : `Reserved Squares: ${data ? data.length : 0}`;
            for (let i = 0; i < totalSquares; i++) {
                let sq = document.createElement("div"); sq.className = "square"; let m = map[i];
                if (m) {
                    sq.classList.add("occupied"); if (m.is_premium) sq.classList.add("premium");
                    if (m.image_url) sq.innerHTML += `<img src="${m.image_url}">`;
                    sq.innerHTML += `<span>${m.is_ghost ? 'ğŸ‘»' : m.name}</span>`;
                    sq.onclick = () => showMemory(m);
                } else {
                    sq.innerHTML = '<i class="fas fa-plus" style="opacity:.2"></i>';
                    sq.onclick = () => { selectedSquare = i; openModal('addModal'); };
                }
                grid.appendChild(sq);
            }
        }

        async function showMemory(m) {
            const viewBox = document.getElementById("viewBox");
            viewBox.innerHTML = `
                <div style="text-align:center">
                    ${m.image_url ? `<img src="${m.image_url}" style="width:100%; border-radius:15px; margin-bottom:15px;">` : ''}
                    <h2>${m.is_ghost ? 'ğŸ‘» Anonymous' : m.name}</h2>
                    <p style="color:var(--accent)">ğŸ“ ${m.country || 'Global'}</p>
                    <p style="font-size:1.1rem">"${m.story}"</p>
                    <button class="btn-main" id="likeBtn">â¤ï¸ Like (${m.likes || 0})</button>
                    <button class="btn-close" onclick="closeModal('viewModal')">Close</button>
                </div>`;
            document.getElementById("likeBtn").onclick = async () => {
                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ Ù‡Ù†Ø§: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ id Ù„Ø±Ù‚Ù… Ø¹Ø´Ø§Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø³ÙŠØ±ÙØ±
                await supabase.rpc("increment_likes", { row_id: parseInt(m.id) });
                closeModal("viewModal"); loadWall();
            };
            openModal("viewModal");
        }

        document.getElementById("saveBtn").onclick = async () => {
            const btn = document.getElementById("saveBtn"); btn.innerText = "..."; btn.disabled = true;
            const file = document.getElementById("imageInput").files[0]; let imageUrl = null;
            if (file) {
                const { data } = await supabase.storage.from("memories").upload(`${Date.now()}_${file.name}`, file);
                if (data) imageUrl = `https://fnbdhcncujueyznrlmpi.supabase.co/storage/v1/object/public/memories/${data.path}`;
            }
            await supabase.from("memories").insert([{
                square_id: selectedSquare, name: document.getElementById("name").value || "Anonymous",
                story: document.getElementById("story").value, country: document.getElementById("country").value,
                is_ghost: document.getElementById("ghostCheck").checked, image_url: imageUrl
            }]);
            btn.innerText = "Ø­ÙØ¸"; btn.disabled = false; closeModal("addModal"); loadWall();
        };
        updateUI();
    </script>
</body>
</html>

