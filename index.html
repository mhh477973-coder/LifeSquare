<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeSquare | The Eternal Vault</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">

    <style>
        :root { --bg:#020617; --card:#0f172a; --accent:#38bdf8; --text:#f8fafc; --gold:#facc15; --error:#ef4444; --glass:rgba(255,255,255,0.05); }
        body { margin:0; background:var(--bg); color:var(--text); font-family:'Cairo',sans-serif; overflow-x:hidden; scroll-behavior:smooth; }
        #starfield { position:fixed; inset:0; z-index:-1; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        header { text-align:center; padding:60px 20px; }
        h1 { font-family:'Orbitron'; font-size:clamp(3rem, 10vw, 5rem); cursor:pointer; background:linear-gradient(to bottom,#fff,var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter: drop-shadow(0 0 15px rgba(56, 189, 248, 0.5)); }

        .stats-bar { background:var(--glass); backdrop-filter:blur(10px); padding:10px 30px; border-radius:50px; border:1px solid rgba(56, 189, 248, 0.3); display:inline-block; margin-top:20px; font-weight:bold; }

        .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; padding:30px; max-width:1400px; margin:auto; }
        .square { aspect-ratio:1; background:var(--card); border-radius:16px; border:1px solid rgba(255,255,255,0.1); position:relative; overflow:hidden; cursor:pointer; transition: 0.4s; display:flex; align-items:center; justify-content:center; }
        .square.empty::before { content:'\f023'; font-family:'Font Awesome 6 Free'; font-weight:900; font-size:1.5rem; color:rgba(255,255,255,0.1); }
        .square:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
        
        .square img { width:100%; height:100%; object-fit:cover; }
        .name-tag { position:absolute; bottom:0; width:100%; background:linear-gradient(transparent, rgba(0,0,0,0.9)); font-size:0.7rem; padding:8px 0; text-align:center; }
        .guardian-icon { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.6); width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid var(--gold); font-size:0.8rem; }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(15px); z-index:9999; align-items:center; justify-content:center; padding:20px; }
        .modal-box { background:#0f172a; padding:30px; border-radius:25px; width:100%; max-width:450px; border:1px solid var(--accent); position:relative; }

        input, textarea { width:100%; padding:12px; margin:8px 0; border-radius:12px; border:none; background:#1e293b; color:#fff; box-sizing: border-box; }
        .btn-main { background:var(--accent); color:#000; width:100%; padding:15px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; margin-top:10px; transition: 0.3s; }
        .btn-main:hover { opacity: 0.9; transform: scale(1.02); }

        .guardian-selector { display: flex; justify-content: space-around; margin: 15px 0; }
        .g-opt { font-size: 1.5rem; cursor: pointer; padding: 10px; border-radius: 10px; transition: 0.3s; background: var(--glass); }
        .g-opt.active { background: var(--accent); transform: scale(1.2); }

        .admin-btn { position:fixed; bottom:25px; left:25px; background:var(--gold); color:#000; padding:15px 20px; border-radius:50px; font-weight:900; border:none; cursor:pointer; display:none; }
        
        .action-btns { display: flex; gap: 10px; margin-top: 15px; }
        .btn-share { background: #fff; color: #000; flex: 1; }
        .btn-like { background: #ef4444; color: #fff; flex: 1; }
    </style>
</head>
<body>

<canvas id="starfield"></canvas>

<header>
    <h1 onclick="adminLogin()">LifeSquare</h1>
    <div class="stats-bar"><i class="fas fa-shield-halved"></i> <span id="memCount">0</span> LEGACIES SECURED</div>
</header>

<div class="grid" id="mainGrid"></div>
<button class="admin-btn" id="adminBtn" onclick="openAdmin()">COMMAND CENTER</button>

<div class="modal" id="addModal">
    <div class="modal-box">
        <h2 style="color:var(--accent); margin-top:0">Secure Your Legacy</h2>
        <input id="name" placeholder="Full Name">
        <textarea id="story" placeholder="Your story for eternity..." rows="3"></textarea>
        
        <p style="font-size:0.8rem; color:#94a3b8">Choose Your Guardian:</p>
        <div class="guardian-selector">
            <div class="g-opt active" onclick="selectG(this, 'üõ°Ô∏è')">üõ°Ô∏è</div>
            <div class="g-opt" onclick="selectG(this, 'ü¶Å')">ü¶Å</div>
            <div class="g-opt" onclick="selectG(this, 'ü§ñ')">ü§ñ</div>
            <div class="g-opt" onclick="selectG(this, 'üêâ')">üêâ</div>
        </div>

        <input type="file" id="imgFile" accept="image/*">
        <button class="btn-main" id="saveBtn">BLAST TO ETERNITY</button>
        <button onclick="closeModal('addModal')" style="background:none; border:none; color:#666; width:100%; margin-top:10px; cursor:pointer">Cancel</button>
    </div>
</div>

<div class="modal" id="viewModal">
    <div class="modal-box" style="text-align:center">
        <div id="viewBox"></div>
        <div class="action-btns">
            <button class="btn-main btn-like" onclick="alert('Liked!')"><i class="fas fa-heart"></i> Like</button>
            <button class="btn-main btn-share" id="shareBtn"><i class="fas fa-share-nodes"></i> Share</button>
        </div>
        <button onclick="closeModal('viewModal')" style="background:none; border:none; color:#666; width:100%; margin-top:15px; cursor:pointer">Close</button>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SB_URL = "https://fnbdhcncujueyznrlmpi.supabase.co";
    const SB_KEY = "YOUR_PUBLIC_ANON_KEY"; // ÿßÿ≥ÿ™ÿ®ÿØŸÑŸá ÿ®ÿßŸÑŸÉŸàÿØ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ
    const supabase = createClient(SB_URL, SB_KEY);

    let selectedGuardian = "üõ°Ô∏è";
    let selectedSquareId = null;

    // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ¨ŸàŸÖ
    const c=document.getElementById("starfield"), x=c.getContext("2d");
    let stars=[];
    function init(){ c.width=innerWidth; c.height=innerHeight; stars=[...Array(150)].map(()=>({x:Math.random()*c.width,y:Math.random()*c.height,s:Math.random()*2,sp:Math.random()*0.5})); }
    function draw(){ x.clearRect(0,0,c.width,c.height); x.fillStyle="#fff"; stars.forEach(s=>{ x.fillRect(s.x,s.y,s.s,s.s); s.y+=s.sp; if(s.y>c.height)s.y=0; }); requestAnimationFrame(draw); }
    init(); draw(); window.addEventListener('resize', init);

    // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿØÿßŸÑÿßÿ™
    window.closeModal = id => document.getElementById(id).style.display = "none";
    window.selectG = (el, icon) => { 
        document.querySelectorAll('.g-opt').forEach(o=>o.classList.remove('active'));
        el.classList.add('active'); selectedGuardian = icon; 
    };

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    async function loadWall() {
        const grid = document.getElementById("mainGrid");
        const { data } = await supabase.from("memories").select("*");
        const map = {}; data?.forEach(m => map[m.square_id] = m);
        document.getElementById("memCount").innerText = data?.length || 0;

        grid.innerHTML = "";
        for(let i=1; i<=200; i++) {
            let sq = document.createElement("div");
            sq.className = "square " + (map[i] ? "occupied" : "empty");
            if(map[i]) {
                sq.innerHTML = `<img src="${map[i].image_url}" loading="lazy"><div class="guardian-icon">${map[i].guardian}</div><div class="name-tag">${map[i].name}</div>`;
                sq.onclick = () => showMemory(map[i]);
            } else {
                sq.onclick = () => { selectedSquareId=i; document.getElementById('addModal').style.display='flex'; };
            }
            grid.appendChild(sq);
        }
    }

    function showMemory(m) {
        document.getElementById("viewBox").innerHTML = `<img src="${m.image_url}" style="width:100%; border-radius:15px"><h2>${m.name}</h2><p>${m.story || ''}</p>`;
        document.getElementById("shareBtn").onclick = () => {
            if(navigator.share) navigator.share({ title: 'LifeSquare', text: `Check out ${m.name}'s legacy!`, url: window.location.href });
        };
        document.getElementById("viewModal").style.display = "flex";
    }

    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    document.getElementById("saveBtn").onclick = async () => {
        const file = document.getElementById("imgFile").files[0];
        const name = document.getElementById("name").value;
        if(!name || !file) return alert("Required: Name & Image");

        document.getElementById("saveBtn").disabled = true;
        document.getElementById("saveBtn").innerText = "SAVING...";

        const fileName = `sq_${Date.now()}.jpg`;
        await supabase.storage.from("memories").upload(fileName, file);
        const { data:{publicUrl} } = supabase.storage.from("memories").getPublicUrl(fileName);

        await supabase.from("memories").insert([{
            square_id: selectedSquareId, name, story: document.getElementById("story").value,
            image_url: publicUrl, guardian: selectedGuardian
        }]);

        location.reload();
    };

    window.adminLogin = () => { if(prompt("Code")==="123") document.getElementById("adminBtn").style.display="block"; };
    window.onload = loadWall;
</script>
</body>
</html>
